from flask import Flask, request, abort, send_from_directory
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage, ImageSendMessage, FileMessage
from app_line_model import *

app = Flask(__name__)

# æ›¿æ¢ä¸ºæ‚¨åœ¨ LINE Developers Console ä¸­è·å¾—çš„ Channel Access Token å’Œ Channel Secret
line_bot_api = LineBotApi('l2CNtB5RsJlPEAIKUM6vCeVczJcTgyT9ZMIyGJ+S7bBVQrDclDDoJxaNOLO9eKDZknqPzFUhRubPT9ahnDthMbodNLZva5/DaZG9EmiouPNpaLRcSyRp6sYiBqrhJ8+LvBQo9Nqe0Z0MlD0qqXrrQAdB04t89/1O/w1cDnyilFU=')
handler = WebhookHandler('eb48800cd65e283b057a6c6daff670b7')

@app.route('/webhook', methods=['POST'])
def webhook():
    # è·å– X-Line-Signature å¤´éƒ¨ä¿¡æ¯
    signature = request.headers['X-Line-Signature']

    # è·å–è¯·æ±‚çš„åŸå§‹æ•°æ®
    body = request.get_data(as_text=True)
    app.logger.info("Request body: " + body)  # è®°å½•è¯·æ±‚ä½“å†…å®¹åˆ°æ—¥å¿—ä¸­

    # å¤„ç† Webhook è¯·æ±‚
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)

    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_text_message(event):
    # è·å–ç”¨æˆ·å‘é€çš„æ¶ˆæ¯å†…å®¹å’Œç”¨æˆ·ID
    user_message = event.message.text
    user_id = event.source.user_id
    app.logger.info("User ID: " + user_id)

    # è·å–ç”¨æˆ·çš„åç§°
    try:
        profile = line_bot_api.get_profile(user_id)
        user_name = profile.display_name
        app.logger.info("User Name: " + user_name)
    except Exception as e:
        app.logger.error(f"Error getting profile: {e}")
        user_name = "æœªçŸ¥ç”¨æˆ·"

    print("userid:"+str(user_id)+"  user_name:"+str(user_name))
    if str(user_message.strip()) in ['14ç¾¤æ¼²æ½®è¡æµªå®¢']:
        #ç¢ºèªæ˜¯å¦å·²ç¶“æ˜¯ç”¨æˆ¶, å¦‚æœä¸æ˜¯å°±æ–°å¢, ä¸¦åˆ¤æ–·æ˜¯å¦åˆ°æœŸ
        end_da, today = query_whitelist14(user_id)
        if len(str(end_da)) != 0:
            today = datetime.now().date()
            if today > end_da:  # ä»Šå¤©æ—¥æœŸå¤§æ–¼ end_da
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text='ä½¿ç”¨æ™‚é–“å·²åˆ°æœŸâš ï¸\n\n0. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+14ç¾¤\n(å„ªæƒ ç¢¼:114F43 æŠ˜åƒ¹å„ªæƒ 1500)\nhttps://www.gorich.com.tw/school/subscribe/6403\n\n1. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+2~8ç¾¤ğŸˆ³è»åŸºåœ°ã€1800æª”åŠæŒ‡æ•¸è‚¡ç¥¨å£“åŠ›æ”¯æ’ã€çŸ­æ³¢æ®µã€é•·æ³¢æ®µã€ç‰›ç†Šé æ¸¬ã€é‰…é¡äº¤æ˜“ã€å­˜è‚¡è¨ˆç•«ï¼Œå¤§ç¦®åŒ…è¨Šè™Ÿæ•™å­¸\nhttps://www.gorich.com.tw/school/subscribe/6407\n\n2. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+9ç¾¤Tickç•¶æ²–è¨Šè™Ÿæ•™å­¸(ä¸é©ç”¨å„ªæƒ ç¢¼)\nhttps://www.gorich.com.tw/school/subscribe/6403\n\nğŸŒŸ3. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+11ç¾¤éš”æ—¥æ²–ã€å°¬ğŸˆ³è¨Šè™Ÿæ•™å­¸\nhttps://www.gorich.com.tw/school/subscribe/6404\n\n4. 10ç¾¤ä¸€æ³¢æµç•¶æ²–ğŸ“ˆã€è¶¨å‹¢æµç•¶æ²–â†•ï¸\n5. 13ç¾¤ å°æŒ‡æˆ°æ©Ÿç¾¤âœˆï¸ï¼ˆæ³¢æ®µï¼‰\n6. 13ç¾¤ å°æŒ‡é™¸è»ç¾¤ğŸª–ï¼ˆç•¶æ²–ï¼‰\næ²’è¨‚é–±è«‹è¯ç¹«å®¢æœğŸ’\n\nğŸŒŸEå¤§:reurl.cc/E6LyXm\n\nğŸŒŸå•ç­”æ©Ÿå™¨äººğŸ¤–\nhttps://reurl.cc/r9z8Rr\né€£çµåœ¨é€™â˜ï¸\n\nğŸŒŸå®¢æœğŸ¤– è¨‚é–±ç¾¤åŠæ©Ÿå™¨äººå•é¡Œéƒ½å¯ä»¥å•ğŸ™‹\nhttps://reurl.cc/2jXo8n'))
                open = 0
            else:
                open = 1
        else:
            insert_whitelist14(user_id, user_name)
            open =1
        if open == 1:
            text_message14_1, text_message14_2 = do_trade11_long2()
            messages = [text_message14_1, text_message14_2]
            filtered_messages = [TextSendMessage(text=msg) for msg in messages if msg.strip()]
            if filtered_messages:  # ç¢ºä¿åˆ—è¡¨éç©º
                line_bot_api.reply_message(event.reply_token, filtered_messages)

    if str(user_message.strip()) in ['12ç¾¤æ³•äººåˆå¤œ']:
        #ç¢ºèªæ˜¯å¦å·²ç¶“æ˜¯ç”¨æˆ¶, å¦‚æœä¸æ˜¯å°±æ–°å¢, ä¸¦åˆ¤æ–·æ˜¯å¦åˆ°æœŸ
        end_da, today = query_whitelist12(user_id)
        if len(str(end_da)) != 0:
            today = datetime.now().date()
            if today > end_da:  # ä»Šå¤©æ—¥æœŸå¤§æ–¼ end_da
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text='ä½¿ç”¨æ™‚é–“å·²åˆ°æœŸâš ï¸\n\n0. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+14ç¾¤\n(å„ªæƒ ç¢¼:114F43 æŠ˜åƒ¹å„ªæƒ 1500)\nhttps://www.gorich.com.tw/school/subscribe/6403\n\n1. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+2~8ç¾¤ğŸˆ³è»åŸºåœ°ã€1800æª”åŠæŒ‡æ•¸è‚¡ç¥¨å£“åŠ›æ”¯æ’ã€çŸ­æ³¢æ®µã€é•·æ³¢æ®µã€ç‰›ç†Šé æ¸¬ã€é‰…é¡äº¤æ˜“ã€å­˜è‚¡è¨ˆç•«ï¼Œå¤§ç¦®åŒ…è¨Šè™Ÿæ•™å­¸\nhttps://www.gorich.com.tw/school/subscribe/6407\n\n2. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+9ç¾¤Tickç•¶æ²–è¨Šè™Ÿæ•™å­¸(ä¸é©ç”¨å„ªæƒ ç¢¼)\nhttps://www.gorich.com.tw/school/subscribe/6403\n\nğŸŒŸ3. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+11ç¾¤éš”æ—¥æ²–ã€å°¬ğŸˆ³è¨Šè™Ÿæ•™å­¸\nhttps://www.gorich.com.tw/school/subscribe/6404\n\n4. 10ç¾¤ä¸€æ³¢æµç•¶æ²–ğŸ“ˆã€è¶¨å‹¢æµç•¶æ²–â†•ï¸\n5. 13ç¾¤ å°æŒ‡æˆ°æ©Ÿç¾¤âœˆï¸ï¼ˆæ³¢æ®µï¼‰\n6. 13ç¾¤ å°æŒ‡é™¸è»ç¾¤ğŸª–ï¼ˆç•¶æ²–ï¼‰\næ²’è¨‚é–±è«‹è¯ç¹«å®¢æœğŸ’\n\nğŸŒŸEå¤§:reurl.cc/E6LyXm\n\nğŸŒŸå•ç­”æ©Ÿå™¨äººğŸ¤–\nhttps://reurl.cc/r9z8Rr\né€£çµåœ¨é€™â˜ï¸\n\nğŸŒŸå®¢æœğŸ¤– è¨‚é–±ç¾¤åŠæ©Ÿå™¨äººå•é¡Œéƒ½å¯ä»¥å•ğŸ™‹\nhttps://reurl.cc/2jXo8n'))
                open = 0
            else:
                open = 1
        else:
            insert_whitelist12(user_id, user_name)
            open =1
        if open == 1:
            text_message12_1 = do_send()
            messages = [text_message12_1]
            filtered_messages = [TextSendMessage(text=msg) for msg in messages if msg.strip()]
            if filtered_messages:  # ç¢ºä¿åˆ—è¡¨éç©º
                line_bot_api.reply_message(event.reply_token, filtered_messages)

    elif str(user_message.strip()) in ['2ç¾¤ç©ºè»åŸºåœ°','4ç¾¤å…¬å¸å®šåƒ¹æ¨¡å‹ã€5ç¾¤ç‰›ç†Šã€6ç¾¤æ™‚é–“ç®¡ç†å¤§å¸«','7ç¾¤é‰…é¡äº¤æ˜“','8ç¾¤æ‘å§‘äº¤å‹ç¶²']:
        #ç¢ºèªæ˜¯å¦å·²ç¶“æ˜¯ç”¨æˆ¶, å¦‚æœä¸æ˜¯å°±æ–°å¢, ä¸¦åˆ¤æ–·æ˜¯å¦åˆ°æœŸ
        end_da, today = query_whitelist2(user_id)
        if len(str(end_da)) != 0:
            today = datetime.now().date()
            if today > end_da:  # ä»Šå¤©æ—¥æœŸå¤§æ–¼ end_da
                line_bot_api.reply_message(event.reply_token, TextSendMessage(text='ä½¿ç”¨æ™‚é–“å·²åˆ°æœŸâš ï¸\n\n0. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+14ç¾¤\n(å„ªæƒ ç¢¼:114F43 æŠ˜åƒ¹å„ªæƒ 1500)\nhttps://www.gorich.com.tw/school/subscribe/6403\n\n1. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+2~8ç¾¤ğŸˆ³è»åŸºåœ°ã€1800æª”åŠæŒ‡æ•¸è‚¡ç¥¨å£“åŠ›æ”¯æ’ã€çŸ­æ³¢æ®µã€é•·æ³¢æ®µã€ç‰›ç†Šé æ¸¬ã€é‰…é¡äº¤æ˜“ã€å­˜è‚¡è¨ˆç•«ï¼Œå¤§ç¦®åŒ…è¨Šè™Ÿæ•™å­¸\nhttps://www.gorich.com.tw/school/subscribe/6407\n\n2. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+9ç¾¤Tickç•¶æ²–è¨Šè™Ÿæ•™å­¸(ä¸é©ç”¨å„ªæƒ ç¢¼)\nhttps://www.gorich.com.tw/school/subscribe/6403\n\nğŸŒŸ3. æ©Ÿå™¨äººğŸ¤–ğŸˆšï¸é™æŸ¥è©¢ä¸¦å¯+11ç¾¤éš”æ—¥æ²–ã€å°¬ğŸˆ³è¨Šè™Ÿæ•™å­¸\nhttps://www.gorich.com.tw/school/subscribe/6404\n\n4. 10ç¾¤ä¸€æ³¢æµç•¶æ²–ğŸ“ˆã€è¶¨å‹¢æµç•¶æ²–â†•ï¸\n5. 13ç¾¤ å°æŒ‡æˆ°æ©Ÿç¾¤âœˆï¸ï¼ˆæ³¢æ®µï¼‰\n6. 13ç¾¤ å°æŒ‡é™¸è»ç¾¤ğŸª–ï¼ˆç•¶æ²–ï¼‰\næ²’è¨‚é–±è«‹è¯ç¹«å®¢æœğŸ’\n\nğŸŒŸEå¤§:reurl.cc/E6LyXm\n\nğŸŒŸå•ç­”æ©Ÿå™¨äººğŸ¤–\nhttps://reurl.cc/r9z8Rr\né€£çµåœ¨é€™â˜ï¸\n\nğŸŒŸå®¢æœğŸ¤– è¨‚é–±ç¾¤åŠæ©Ÿå™¨äººå•é¡Œéƒ½å¯ä»¥å•ğŸ™‹\nhttps://reurl.cc/2jXo8n'))
                open = 0
            else:
                open = 1
        else:
            insert_whitelist2(user_id, user_name)
            open =1

        if open == 1:
            if str(user_message.strip()) == '2ç¾¤ç©ºè»åŸºåœ°':
                try:
                    text_message2_1 = send_maintrend_stock_top_performance()
                    text_message2_2, text_message2_3 = send_maintrend_stock_self()
                    messages = [text_message2_1, text_message2_2, text_message2_3]
                    filtered_messages = [TextSendMessage(text=msg) for msg in messages if msg.strip()]
                    if filtered_messages:  # ç¢ºä¿åˆ—è¡¨éç©º
                        line_bot_api.reply_message(event.reply_token, filtered_messages)
                except:
                    line_bot_api.reply_message(event.reply_token, TextSendMessage(text="è«‹æ–¼æ™šä¸Š21:30å¾ŒæŸ¥è©¢ï¼"))

            elif str(user_message.strip()) == '4ç¾¤å…¬å¸å®šåƒ¹æ¨¡å‹ã€5ç¾¤ç‰›ç†Šã€6ç¾¤æ™‚é–“ç®¡ç†å¤§å¸«':
                text_message4_1, text_message4_2 = accounting_strategy_pln('MC200_VOL1000(TOP5_offset0)-20D(VXX)D20_VXX', 'å…¬å¸å®šåƒ¹æ¨¡å‹', 20, '', 0.05, 0.1, 0.3)
                text_message4_1 = text_message4_1.replace('\nç­–ç•¥åç¨±:', '4ç¾¤.ğŸ¢')
                text_message4_2 = text_message4_2.replace('\nç­–ç•¥åç¨±:', '4ç¾¤.ğŸ¢')
                text_message5_1 = do_timing()
                text_message6_1, text_message6_2 = accounting_strategy_pln('MC1000_VOL1000(TOP5)-5D(dt)D5_MT>WT', 'æ™‚é–“ç®¡ç†å¤§å¸«åŠ å¼·ç‰ˆ', 5, '', 0.05, 0.1, 0.3)
                text_message6_1 = text_message6_1.replace('\nç­–ç•¥åç¨±:', '6ç¾¤.âŒšï¸')
                text_message6_2 = text_message6_2.replace('\nç­–ç•¥åç¨±:', '6ç¾¤.âŒšï¸')
                messages = [text_message4_1,text_message4_2,text_message5_1,text_message6_1,text_message6_2,]
                filtered_messages = [TextSendMessage(text=msg) for msg in messages if msg.strip()]
                if filtered_messages:  # ç¢ºä¿åˆ—è¡¨éç©º
                    line_bot_api.reply_message(event.reply_token, filtered_messages)

            elif str(user_message.strip()) == '7ç¾¤é‰…é¡äº¤æ˜“':
                text_message_list7_1 = do_add_ma5_over_ma30()
                text_message_list7_2 = do_keep_ma5_over_ma30()
                messages = text_message_list7_1 + text_message_list7_2
                filtered_messages = [TextSendMessage(text=msg) for msg in messages if msg.strip()]
                if filtered_messages:  # ç¢ºä¿åˆ—è¡¨éç©º
                    line_bot_api.reply_message(event.reply_token, filtered_messages)

            elif str(user_message.strip()) == '8ç¾¤æ‘å§‘äº¤å‹ç¶²':
                text_message_list8_1 = code_indicator_cash_dev()
                messages = text_message_list8_1
                filtered_messages = [TextSendMessage(text=msg) for msg in messages if msg.strip()]
                if filtered_messages:  # ç¢ºä¿åˆ—è¡¨éç©º
                    line_bot_api.reply_message(event.reply_token, filtered_messages)

    if str(user_message.strip()) == '9ç¾¤æ•™å­¸èªªæ˜':
        image_message1 = ImageSendMessage(
            original_content_url='https://i.ibb.co/c2BYxNT/S-17621000-0.jpg',
            preview_image_url='https://i.ibb.co/c2BYxNT/S-17621000-0.jpg'
        )
        image_message2 = ImageSendMessage(
            original_content_url='https://i.ibb.co/y88p9t9/S-17620999-0.jpg',
            preview_image_url='https://i.ibb.co/y88p9t9/S-17620999-0.jpg'
        )
        image_message3 = ImageSendMessage(
            original_content_url='https://i.ibb.co/j8D4LgK/S-17620997-0.jpg',
            preview_image_url='https://i.ibb.co/j8D4LgK/S-17620997-0.jpg'
        )
        line_bot_api.reply_message(event.reply_token, [image_message1, image_message2, image_message3])

if __name__ == "__main__":
    #app.run(debug=True)
    app.run(host="127.0.0.1", port=5001, debug=False)